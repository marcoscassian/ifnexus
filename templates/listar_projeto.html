{% extends 'base.html' %}

{% block title %}Cadastrar Projeto{% endblock %}

{% block estilos %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/listar_projeto.css') }}">
{% endblock %}

{% block conteudo %}
<div class="container">
    <div class="left">
        <div class="block1">
            <h1> {{projeto.titulo}} - {{projeto.subtitulo}}</h1>
            <div class="descricao">
                <p> {{projeto.descricao}} </p>
            </div>
            <div class="autores">
                <p><strong>Autores:</strong> 
                    {{ projeto.autores | map(attribute='nome') | join(', ') }}
                </p>
            </div>
            <hr>

        </div>

        <div class="block2">
            <h1> Objetivos </h1>
            <ul>
                {% for objetivo in projeto.objetivos %}
                <li>{{ objetivo.descricao }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="block3">
            <h1> Metodologias </h1>
            <ul>
                {% for metodologia in projeto.metodologias %}
                <li>{{ metodologia.descricao }}</li>
                {% endfor %}
            </ul>
        </div>

        <div class="block4">
            <h1> Links e Materias Coplementares </h1>
            <ul>
                {% for link in projeto.links %}
                <li>{{ link.url }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

        <div class="right">
            <div class="media-block">
              <i class="fas fa-play"></i>
        </div>
            <div class="media-block">
                <i class="fas fa-camera"></i>
        </div>
            <div class="media-block">
                <i class="fas fa-camera"></i>
        </div>
            <div class="media-block">
                <i class="fas fa-camera"></i>
        </div>
    </div>

    </div>
    </div>

    <div class="interactions">
        <div class="comment-compose">
            <div class="avatar-col">
                {% if current_user.is_authenticated and current_user.foto %}
                    {% set foto = current_user.foto %}
                    {% if 'http' in foto %}
                        <img src="{{ foto }}" alt="{{ current_user.nome }}" class="comment-avatar-img">
                    {% else %}
                        <img src="{{ url_for('static', filename='uploads/img/' + foto) }}" alt="{{ current_user.nome }}" class="comment-avatar-img">
                    {% endif %}
                {% else %}
                    <img src="{{ url_for('static', filename='img/geral/default-avatar.png') }}" alt="Avatar" class="comment-avatar-img">
                {% endif %}
            </div>

            <div class="input-col">
                <form id="comment-form" action="{{ url_for('adicionar_comentario', id=projeto.id) }}" method="post" class="comment-form">
                    <textarea id="comment-textarea" name="conteudo" rows="3" placeholder="O que você achou desse projeto?"></textarea>
                    <div style="margin-top:8px; text-align:right;">
                        <button type="submit" class="btn-submit">Enviar comentário</button>
                    </div>
                </form>
            </div>

            <div class="divider-vertical" aria-hidden="true"></div>

            <div class="meta-col">
                <div class="meta-row like-counter">
                    <form id="like-form" action="{{ url_for('curtir_projeto', id=projeto.id) }}" method="post">
                        <button type="submit" id="like-btn" class="like-btn" aria-label="Curtir projeto">
                            {% set liked_src = (url_for('static', filename='img/interacoes/curtidas/heartliked.png') if heart_liked_exists else '') %}
                            {% set unliked_src = (url_for('static', filename='img/interacoes/curtidas/heart.png') if heart_exists else '') %}
                            {% set hover_src = (url_for('static', filename='img/interacoes/curtidas/hearthover.png') if heart_hover_exists else '') %}

                            {% if liked %}
                                <img id="like-img"
                                    src="{{ liked_src }}"
                                    alt="curtido"
                                    data-liked="1"
                                    data-liked-src="{{ liked_src }}"
                                    data-unliked-src="{{ unliked_src }}"
                                    data-hover-src="{{ hover_src }}">
                            {% else %}
                                <img id="like-img"
                                    src="{{ unliked_src }}"
                                    alt="curtir"
                                    data-liked="0"
                                    data-liked-src="{{ liked_src }}"
                                    data-unliked-src="{{ unliked_src }}"
                                    data-hover-src="{{ hover_src }}">
                            {% endif %}
                            <span id="like-count">{{ projeto.curtidas or 0 }} Curtidas</span>
                        </button>
                    </form>
                </div>

                <div class="meta-row share-action">
                    <button id="share-btn" class="share-button">
                        <img src="{{ url_for('static', filename='img/interacoes/compartilhamento/share.png') }}" 
                            alt="Compartilhar" class="share-icon">
                        <span>Compartilhar Projeto</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="comments-list">
            {% for comentario in comentarios %}
            <div class="comment-item">
                <div class="ci-avatar">
                    {% if comentario.usuario.foto %}
                        {% if 'http' in comentario.usuario.foto %}
                            <img src="{{ comentario.usuario.foto }}" alt="{{ comentario.usuario.nome }}" class="comment-avatar-img">
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/img/' + comentario.usuario.foto) }}" alt="{{ comentario.usuario.nome }}" class="comment-avatar-img">
                        {% endif %}
                    {% else %}
                        <img src="{{ url_for('static', filename='img/geral/default-avatar.png') }}" alt="Avatar" class="comment-avatar-img">
                    {% endif %}
                </div>

                <div class="ci-body">
                    <div class="ci-author">{{ comentario.usuario.nome }}</div>
                    <div class="ci-meta" data-ts-ms="{{ (comentario.criado_em.timestamp() * 1000)|int }}">{{ comentario.criado_em.strftime('%d/%m/%Y %H:%M') }}</div>
                    <div class="ci-text">{{ comentario.conteudo }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>


<script>
    // Script para converter datas em "tempo atrás"
    document.addEventListener('DOMContentLoaded', function(){
        function timeAgoFromMs(ms){
            try{
                var then = new Date(Number(ms));
                if(isNaN(then)) return '';
                var now = new Date();
                var diff = now.getTime() - then.getTime(); // ms
                var seconds = Math.floor(diff / 1000);
                var minutes = Math.floor(seconds / 60);
                var hours = Math.floor(minutes / 60);
                var days = Math.floor(hours / 24);
                var months = Math.floor(days / 30);
                var years = Math.floor(days / 365);

                if(years >= 1){
                    return then.toLocaleDateString();
                }
                if(months >= 1){
                    return 'há ' + months + (months === 1 ? ' mês' : ' meses');
                }
                if(days >= 1){
                    return 'há ' + days + (days === 1 ? ' dia' : ' dias');
                }
                if(hours >= 1){
                    return 'há ' + hours + (hours === 1 ? ' hora' : ' horas');
                }
                if(minutes >= 1){
                    return 'há ' + minutes + (minutes === 1 ? ' minuto' : ' minutos');
                }
                return 'agora mesmo';
            }catch(err){
                return '';
            }
        }

        var dateEls = document.querySelectorAll('.comment-date[data-ts-ms]');
        dateEls.forEach(function(el){
            var ms = el.getAttribute('data-ts-ms');
            var text = timeAgoFromMs(ms);
            if(text) el.textContent = text;
        });
    });

    // Hover do ícone de curtida e submissão AJAX
    (function(){
        var likeForm = document.getElementById('like-form');
        var likeImg = document.getElementById('like-img');
        var likeCount = document.getElementById('like-count');
        if(!likeImg) return;

        function applyHover(){
            var newImg = likeImg.cloneNode(true);
            likeImg.parentNode.replaceChild(newImg, likeImg);
            likeImg = newImg;

            var originalSrc = likeImg.getAttribute('src');
            var hoverSrc = likeImg.dataset.hoverSrc || null;
            var liked = likeImg.dataset.liked === '1';

            if(!liked && hoverSrc){
                likeImg.addEventListener('mouseenter', function(){
                    likeImg.setAttribute('src', hoverSrc);
                });
                likeImg.addEventListener('mouseleave', function(){
                    likeImg.setAttribute('src', originalSrc);
                });
            }
        }

        applyHover();

        if(!likeForm) return;

        likeForm.addEventListener('submit', function(e){
            e.preventDefault();
            var btn = likeForm.querySelector('button[type="submit"]');
            if(btn) btn.disabled = true;

            fetch(likeForm.action, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            }).then(function(resp){
                return resp.json().then(function(data){ return {status: resp.status, body: data}; });
            }).then(function(res){
                if(res.status === 200 && res.body){
                    var liked = !!res.body.liked;
                    var curtidas = res.body.curtidas;

                    var likedSrc = likeImg.dataset.likedSrc || '';
                    var unlikedSrc = likeImg.dataset.unlikedSrc || '';
                    if(liked && likedSrc){
                        likeImg.setAttribute('src', likedSrc);
                        likeImg.dataset.liked = '1';
                    } else {
                        if(unlikedSrc) likeImg.setAttribute('src', unlikedSrc);
                        likeImg.dataset.liked = '0';
                    }
                    if(likeCount) likeCount.textContent = curtidas + " Curtidas";
                    applyHover();
                } else {
                    console.error('Erro ao curtir:', res.body && res.body.error ? res.body.error : res);
                    alert('Erro ao atualizar curtida.');
                }
            }).catch(function(err){
                console.error(err);
                alert('Erro de rede ao curtir.');
            }).finally(function(){
                if(btn) btn.disabled = false;
            });
        });
    })();

    // Compartilhamento via Web Share API

    document.getElementById("share-btn").addEventListener("click", function () {

        if (navigator.share) {
            navigator.share({
                title: "Olha esse projeto!",
                text: "Dá uma olhada nesse projeto do Nexus IF:",
                url: window.location.href
            })
            .then(() => console.log("Compartilhado com sucesso"))
            .catch((err) => console.log("Erro ao compartilhar:", err));

        } else {
            alert("Compartilhamento não suportado neste navegador.");
        }
    });

</script>
{% endblock %}