{% extends 'base.html' %}

{% block title %}Cadastrar Projeto{% endblock %}

{% block estilos %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/listar_projeto.css') }}">
{% endblock %}

{% block conteudo %}

<div class="page-wrapper">

    <div class="container">

        <div class="left">
            <div class="block1">
                <h1> {{projeto.titulo}} - {{projeto.subtitulo}}</h1>

                <div class="descricao">
                    <p> {{projeto.descricao}} </p>
                </div>

                <div class="autores">
                    <p><strong>Autores:</strong>
                        {% for autor in projeto.autores %}
                            {{ autor.usuario.nome }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                </div>

                <hr>
            </div>

            <div class="block2">
                <h1> Objetivos </h1>
                <ul>
                    {% for objetivo in projeto.objetivos %}
                    <li>{{ objetivo.descricao }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="block3">
                <h1> Metodologias </h1>
                <ul>
                    {% for metodologia in projeto.metodologias %}
                    <li>{{ metodologia.descricao }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="block4">
                <h1> Links e Materias Coplementares </h1>
                <ul>
                    {% for link in projeto.links %}
                    <li>{{ link.url }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="right">
            {% if imagens and imagens|length > 0 %}
                {% for img in imagens %}
                <div class="media-block">
                    <img src="{{ img }}" alt="Imagem do projeto" class="project-img">
                </div>
                {% endfor %}
            {% else %}
                <div class="media-block">
                    <i class="fas fa-camera"></i>
                </div>
            {% endif %}
        </div>

    </div>

    <div class="interactions">

        <div class="comment-compose">

            <div class="avatar-col">
                {% if current_user.is_authenticated and current_user.foto %}
                    {% set foto = current_user.foto %}
                    {% if 'http' in foto %}
                        <img src="{{ foto }}" alt="{{ current_user.nome }}" class="comment-avatar-img">
                    {% else %}
                        {% if current_user.foto %}
                            {% if 'http' in current_user.foto %}
                                <img src="{{ current_user.foto }}" class="comment-avatar-img">
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/users/' ~ current_user.id ~ '.jpg') }}" class="comment-avatar-img">
                            {% endif %}
                        {% else %}
                            <img src="{{ url_for('static', filename='img/geral/default-avatar.png') }}" class="comment-avatar-img">
                        {% endif %}

                    {% endif %}
                {% else %}
                    <img src="{{ url_for('static', filename='img/geral/default-avatar.png') }}" alt="Avatar" class="comment-avatar-img">
                {% endif %}
            </div>

            <div class="input-col">
                <form id="comment-form" action="{{ url_for('adicionar_comentario', id=projeto.id) }}" method="post" class="comment-form">
                    <textarea id="comment-textarea" name="conteudo" rows="3" placeholder="O que você achou desse projeto?"></textarea>
                    <div style="margin-top:8px; text-align:right;">
                        <button type="submit" class="btn-submit">Enviar comentário</button>
                    </div>
                </form>
            </div>

            <div class="divider-vertical" aria-hidden="true"></div>

            <div class="meta-col">

                <div class="meta-row like-counter">
                    <form id="like-form" action="{{ url_for('curtir_projeto', id=projeto.id) }}" method="post">
                        <button type="submit" id="like-btn" class="like-btn" aria-label="Curtir projeto">

                            {% set liked_src = (url_for('static', filename='img/interacoes/curtidas/heartliked.png') if heart_liked_exists else '') %}
                            {% set unliked_src = (url_for('static', filename='img/interacoes/curtidas/heart.png') if heart_exists else '') %}
                            {% set hover_src = (url_for('static', filename='img/interacoes/curtidas/hearthover.png') if heart_hover_exists else '') %}

                            {% if liked %}
                                <img id="like-img"
                                    src="{{ liked_src }}"
                                    alt="curtido"
                                    data-liked="1"
                                    data-liked-src="{{ liked_src }}"
                                    data-unliked-src="{{ unliked_src }}"
                                    data-hover-src="{{ hover_src }}">
                            {% else %}
                                <img id="like-img"
                                    src="{{ unliked_src }}"
                                    alt="curtir"
                                    data-liked="0"
                                    data-liked-src="{{ liked_src }}"
                                    data-unliked-src="{{ unliked_src }}"
                                    data-hover-src="{{ hover_src }}">
                            {% endif %}
                            <span id="like-count">{{ projeto.curtidas or 0 }} Curtidas</span>
                        </button>
                    </form>
                </div>

                <div class="meta-row share-action">
                    <button id="share-btn" class="share-button">
                        <img src="{{ url_for('static', filename='img/interacoes/compartilhamento/share.png') }}" 
                            alt="Compartilhar" class="share-icon">
                        <span>Compartilhar Projeto</span>
                    </button>
                </div>

            </div>
        </div>

        <div class="comments-list">
            {% for comentario in comentarios %}
            <div class="comment-item">

                <div class="ci-avatar">
                    {% if comentario.usuario.foto %}
                        {% if 'http' in comentario.usuario.foto %}
                            <img src="{{ comentario.usuario.foto }}" alt="{{ comentario.usuario.nome }}" class="comment-avatar-img">
                        {% else %}
                            {% if 'http' in comentario.usuario.foto %}
                                <img src="{{ comentario.usuario.foto }}" class="comment-avatar-img">
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/users/' ~ comentario.usuario.id ~ '.jpg') }}" class="comment-avatar-img">
                            {% endif %}
                        {% endif %}
                    {% else %}
                        <img src="{{ url_for('static', filename='img/geral/default-avatar.png') }}" alt="Avatar" class="comment-avatar-img">
                    {% endif %}
                </div>

                <div class="ci-body">
                    <div class="ci-author">{{ comentario.usuario.nome }}</div>
                    <div class="ci-meta">
                        {% if comentario.criado_em %}
                            <span title="{{ comentario.criado_em.strftime('%d/%m/%Y %H:%M:%S') }}">{{ comentarios_relativos[comentario.id] }}</span>
                        {% else %}
                            Data indisponível
                        {% endif %}
                    </div>
                    <div class="ci-text">{{ comentario.conteudo }}</div>
                </div>

            </div>
            {% endfor %}
        </div>

    </div>

</div>


<script>
    (function(){
        function getRelativeTime(tsMs){
            var now = Date.now();
            var diffMs = now - tsMs;
            if(diffMs < 0 || isNaN(diffMs)){
                return 'data inválida';
            }
            
            var diffSec = Math.floor(diffMs / 1000);
            var diffMin = Math.floor(diffSec / 60);
            var diffHour = Math.floor(diffMin / 60);
            var diffDay = Math.floor(diffHour / 24);
            
            if(diffSec < 60) return 'agora';
            if(diffMin < 60) return 'há ' + diffMin + ' minuto' + (diffMin > 1 ? 's' : '');
            if(diffHour < 24) return 'há ' + diffHour + ' hora' + (diffHour > 1 ? 's' : '');
            if(diffDay < 7) return 'há ' + diffDay + ' dia' + (diffDay > 1 ? 's' : '');

            var date = new Date(tsMs);
            return date.toLocaleDateString('pt-BR') + ' às ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        }
    
        var metaElements = document.querySelectorAll('.ci-meta[data-ts-ms]');
        metaElements.forEach(function(el){
            var tsMs = parseInt(el.getAttribute('data-ts-ms'), 10);
            if(!isNaN(tsMs) && tsMs > 0){
                el.textContent = getRelativeTime(tsMs);
                el.title = new Date(tsMs).toLocaleString('pt-BR');
            }
        });
    })();

    (function(){
        var likeForm = document.getElementById('like-form');
        var likeImg = document.getElementById('like-img');
        var likeCount = document.getElementById('like-count');
        if(!likeImg) return;

        function applyHover(){
            var newImg = likeImg.cloneNode(true);
            likeImg.parentNode.replaceChild(newImg, likeImg);
            likeImg = newImg;

            var originalSrc = likeImg.getAttribute('src');
            var hoverSrc = likeImg.dataset.hoverSrc || null;
            var liked = likeImg.dataset.liked === '1';

            if(!liked && hoverSrc){
                likeImg.addEventListener('mouseenter', function(){
                    likeImg.setAttribute('src', hoverSrc);
                });
                likeImg.addEventListener('mouseleave', function(){
                    likeImg.setAttribute('src', originalSrc);
                });
            }
        }

        applyHover();

        if(!likeForm) return;

        likeForm.addEventListener('submit', function(e){
            e.preventDefault();
            var btn = likeForm.querySelector('button[type="submit"]');
            if(btn) btn.disabled = true;

            fetch(likeForm.action, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            }).then(function(resp){
                return resp.json().then(function(data){ return {status: resp.status, body: data}; });
            }).then(function(res){
                if(res.status === 200 && res.body){
                    var liked = !!res.body.liked;
                    var curtidas = res.body.curtidas;

                    var likedSrc = likeImg.dataset.likedSrc || '';
                    var unlikedSrc = likeImg.dataset.unlikedSrc || '';
                    if(liked && likedSrc){
                        likeImg.setAttribute('src', likedSrc);
                        likeImg.dataset.liked = '1';
                    } else {
                        if(unlikedSrc) likeImg.setAttribute('src', unlikedSrc);
                        likeImg.dataset.liked = '0';
                    }
                    if(likeCount) likeCount.textContent = curtidas + " Curtidas";
                    applyHover();
                } else {
                    console.error('Erro ao curtir:', res.body && res.body.error ? res.body.error : res);
                    alert('Erro ao atualizar curtida.');
                }
            }).catch(function(err){
                console.error(err);
                alert('Erro de rede ao curtir.');
            }).finally(function(){
                if(btn) btn.disabled = false;
            });
        });
    })();

    // Compartilhamento via Web Share API

    document.getElementById("share-btn").addEventListener("click", function () {

        if (navigator.share) {
            navigator.share({
                title: "Olha esse projeto!",
                text: "Dá uma olhada nesse projeto do Nexus IF:",
                url: window.location.href
            })
            .then(() => console.log("Compartilhado com sucesso"))
            .catch((err) => console.log("Erro ao compartilhar:", err));

        } else {
            alert("Compartilhamento não suportado neste navegador.");
        }
    });

</script>

<!-- modal para visualização ampliada das imagens -->

<div id="img-modal" class="img-modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
        <button class="close-btn" id="img-modal-close" aria-label="Fechar">✕</button>
        <img id="img-modal-img" class="modal-img" src="" alt="Imagem ampliada">
    </div>
</div>

<script>
    (function(){
        var modal = document.getElementById('img-modal');
        var modalImg = document.getElementById('img-modal-img');
        var closeBtn = document.getElementById('img-modal-close');

        function openModal(src, alt){
            if(!modal || !modalImg) return;
            modalImg.src = src;
            modalImg.alt = alt || 'Imagem do projeto';
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            // trava o scroll de fundo
            document.body.style.overflow = 'hidden';
        }

        function closeModal(){
            if(!modal) return;
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            modalImg.src = '';
            document.body.style.overflow = '';
        }

        // Delegação: atribui clique em cada imagem de projeto
        var thumbs = document.querySelectorAll('.project-img');
        thumbs.forEach(function(img){
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', function(e){
                openModal(img.src, img.alt || 'Imagem do projeto');
            });
        });

        // Fechar por botão, clique no backdrop ou ESC
        if(closeBtn) closeBtn.addEventListener('click', closeModal);
        if(modal) modal.addEventListener('click', function(e){
            if(e.target === modal) closeModal();
        });
        document.addEventListener('keydown', function(e){
            if(e.key === 'Escape') closeModal();
        });
    })();
</script>
{% endblock %}